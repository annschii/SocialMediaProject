<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/searchPost.css" />
    <title>POSTS</title>

</head>
<body>
    <div class="secretTitle">
        <h2 class="title" onclick="window.location.href='../main.html'">secret</h2>
        <h2>secret</h2>
    </div>

    <h1>POSTS</h1>

	<form id="postSearchForm" onsubmit="searchPosts(event)">
        <label for="postId"></label>
        <input class="userInput" type="text" id="postId" name="postId" placeholder="Post ID">
        <label for="userId"></label>
        <input class="userInput" type="text" id="userId" name="userId" placeholder="User ID">
        <label for="text"></label>
        <input class="userInput" type="text" id="text" name="text" placeholder="Text">
        <!-- <section id="btn"><button class="noselect" type="submit">Search Post</button><div id="circle"></div></section> -->
        <button class="custom-btn btn" type="submit">Search Post</button>
    </form>
    <table id="posts">
        <thead>
            <tr>
                <th>User</th>
                <th>Text</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
        const baseUrl = 'http://localhost:5000';

        async function getAllPosts() {
            const response = await fetch(`${baseUrl}/posts`);
            const posts = await response.json();
            const postsList = document.getElementById('posts');
            postsList.innerHTML = posts.map(post => `<li>${post.text}</li>`).join('');
        }

        async function searchPosts(event) {
            event.preventDefault();

            const postId = document.getElementById('postId').value;
            const userId = document.getElementById('userId').value;
            const text = document.getElementById('text').value;

            const queryParams = new URLSearchParams();
            if (postId) queryParams.append('id', postId);
            if (userId) queryParams.append('user_id', userId);
            if (text) queryParams.append('text', text);

            const response = await fetch(`${baseUrl}/posts?${queryParams}`);
            const postsData = await response.json(); // Change variable name to postsData

            const postsTableBody = document.querySelector('#posts tbody');
            postsTableBody.innerHTML = postsData.map(post => `
                <tr>
                    <td>${post.user}</td>
                    <td>${post.text}</td>
                </tr>
            `).join('');

            // Fetch and display images
            displayPosts(postsData);
        }


        async function displayPosts(posts) {
            const postsTableBody = document.querySelector('#posts tbody');
            postsTableBody.innerHTML = '';

            for (const post of posts) {
                const row = document.createElement('tr');

                // Display user and text
                const userCell = document.createElement('td');
                userCell.textContent = post.user;
                row.appendChild(userCell);

                const textCell = document.createElement('td');
                textCell.textContent = post.text;
                row.appendChild(textCell);

                // Fetch and display the image
                const imageResponse = await fetch(`${baseUrl}/images/${post.image}`);
                if (imageResponse.ok) {
                    const imageBlob = await imageResponse.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);

                    const imageCell = document.createElement('td');
                    const imageElement = document.createElement('img');
                    imageElement.src = imageUrl;
                    imageElement.alt = 'Post Image';
                    imageElement.classList.add('clickable-image'); // Add a class for easy selection
                    imageCell.appendChild(imageElement);
                    row.appendChild(imageCell);
                } else {
                    console.error('Failed to fetch image:', imageResponse.statusText);
                }

                postsTableBody.appendChild(row);
            }

            // Add event listener to all images with the 'clickable-image' class
            document.querySelectorAll('.clickable-image').forEach(image => {
                image.addEventListener('click', openImageModal);
            });
        }

        let modal; // Declare a variable to store the modal element

        function openImageModal(event) {
            const clickedImage = event.target;

            // Check if the modal is already created, if not, create it
            if (!modal) {
                modal = document.createElement('div');
                modal.classList.add('image-modal');

                // Create an image element inside the modal
                const modalImage = document.createElement('img');
                modalImage.alt = 'Enlarged Image';
                modal.appendChild(modalImage);

                // Add a click event listener to close the modal on click
                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    modal = null; // Reset the modal variable
                });
            }

            // Set the source of the modal image
            modal.querySelector('img').src = clickedImage.src;

            // Add modal to the document body if it's not already added
            if (!document.contains(modal)) {
                document.body.appendChild(modal);
            }
        }

</script>

</body>
</html>

